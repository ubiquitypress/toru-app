{% extends "base.html" %}
{% load bootstrap3 %}

{% block title %}User Home{% endblock %}

{% block breadcrumbs %}
    <ol class="breadcrumb">
	  <li><a href="/">Home</a></li>
	  <li class="active">User</li>
	</ol>
{% endblock %}

{% block body %}
<div class="col-md-12">
	<div class="row">
		<div class="col-md-11">
			<h1>User Home</h1>
		</div>
		<div class="col-md-1">
            <div class="btn-group">
                <a class="btn dropdown-toggle btn-primary" data-toggle="dropdown" href="#">
                    Action
                    <span class="icon-cog icon-white"></span><span class="caret"></span>
                </a>
                <ul class="dropdown-menu">
                	{% include "core/user/action_bar.html" %}
                </ul>
            </div>
        </div>
    </div>
    <div class="row" id="dashboard-grid">
		<div class="col-md-4" id="task-list">
			<h3><i class="fa fa-tasks"></i>&nbsp;Tasks</h3>
			{% for task in task_list %}
			<div id="task-{{ task.id }}" class="bs-callout bs-callout-{{ task.workflow }}" id="callout-helper-bg-specificity">
					<label class="checkbox-inline">
				 	 <input type="checkbox" id="{{ task.id }}" value="{{ task.id }}"> {{ task.text }}{% if task.due %} <span class="small">- {{ task.due }}</span>{% endif %}
				</label>
			</div>

	      	{% empty %}
	  		<div id="new_task" class="bs-callout bs-callout" id="callout-helper-bg-specificity">
				<p>No tasks</p>
			</div>
			{% endfor %}
			<button type="button" class="btn btn-primary btn-sm" data-toggle="modal" data-target="#myModal">
				<i class="fa fa-plus"></i> New Task
			</button>
		</div>

		<div class="col-md-4">
			<h3><i class="fa fa-tasks"></i>&nbsp;My Proposals</h3>
			{% for proposal in user_proposals %}
			<div class="bs-callout bs-callout-submission" id="callout-helper-bg-specificity">
				<p>{{ proposal.title|truncatechars:70 }}</p>
			</div>
			{% empty %}
			<div class="bs-callout bs-callout" id="callout-helper-bg-specificity">
			<p>No proposals</p>
			</div>
			{% endfor %}
		</div>

		<div class="col-md-4">
			<h3><i class="fa fa-tasks"></i>&nbsp;My Submissions</h3>
			{% for submission in user_submissions %}
			<div class="bs-callout bs-callout-submission" id="callout-helper-bg-specificity">
				<p>{% if submission.stage %}<a href="{% url 'user_submission' submission.id %}">{% else %}<a href="/submission/book/{{ submission.id }}/stage/{{ submission.submission_stage }}/">{% endif %}{{ submission.title|truncatechars:70 }} - <span class="small">{% if submission.stage %}{{ submission.stage.get_current_stage_display }}{% else %}Submission in Progress{% endif %}</span></p></a>
			</div>
			{% empty %}
			<div class="bs-callout bs-callout" id="callout-helper-bg-specificity">
			<p>No submissions</p>
		</div>
			{% endfor %}
		</div>
		{% if 'book-editor' in roles %}
		<div class="col-md-4">
			<h3><i class="fa fa-tasks"></i>&nbsp;Editor</h3>
			<div class="bs-callout bs-callout-submission" id="callout-helper-bg-specificity">
				<p><a href="{% url 'proposals' %}">{{ proposals }} New Proposals</a></p>
			</div>
			<div class="bs-callout bs-callout-submission" id="callout-helper-bg-specificity">
				<p><a href="{% url 'new_submissions' %}">{{ new_submissions }} New Submissions</a></p>
			</div>
			<div class="bs-callout bs-callout-review" id="callout-helper-bg-specificity">
				<p><a href="{% url 'in_review' %}">{{ in_review }} Submissions in Review</a></p>
			</div>
			<div class="bs-callout bs-callout-editing" id="callout-helper-bg-specificity">
				<p><a href="{% url 'in_editing' %}">{{ in_editing }} Submissions in Editing</a></p>
			</div>
		</div>
		{% endif %}
		{% if 'copyeditor' in roles %}
		<div class="col-md-4">
			<h3><i class="fa fa-tasks"></i>&nbsp;Copyeditor</h3>
			{% for copyedit in copyedits %}
			<div class="bs-callout bs-callout-submission" id="callout-helper-bg-specificity">
				<p><a href="#">Copyedit for {{ copyedit.book.title }} due on {{ copyedit.due }}</a></p>
			</div>
			{% empty %}
			<div class="bs-callout" id="callout-helper-bg-specificity">
				<p>No copyedit requests.</p>
			</div>
			{% endfor %}
		</div>
		{% endif %}
		<div class="col-md-4">
			<h3><i class="fa fa-tasks"></i>&nbsp;Author Tasks</h3>
			{% for task in author_copyedit_tasks %}
			<div class="bs-callout bs-callout-submission" id="callout-helper-bg-specificity">
				<p><a href="{{ task.url }}">{{ task.task }} for {{ task.title }}</a></p>
			</div>
			{% empty %}
			<div class="bs-callout" id="callout-helper-bg-specificity">
				<p>No author tasks.</p>
			</div>
			{% endfor %}
		</div>
		{% if 'indexer' in roles %}
		<div class="col-md-4">
			<h3><i class="fa fa-tasks"></i>&nbsp;Indexing</h3>
			{% for index in indexes %}
			<!-- url 'index' index.book.id index.id  removed-->
			<div class="bs-callout bs-callout-submission" id="callout-helper-bg-specificity">
				<p><a href="#">Index for {{ index.book.title }} due on {{ index.due }}</a></p>
			</div>
			{% empty %}
			<div class="bs-callout" id="callout-helper-bg-specificity">
				<p>No indexing requests.</p>
			</div>
			{% endfor %}
		</div>
		{% endif %}
		{% if 'typesetter' in roles %}
		<div class="col-md-4">
			<h3><i class="fa fa-tasks"></i>&nbsp;Typesetter</h3>
			{% for typeset in typesetting %}
			<div class="bs-callout bs-callout-submission" id="callout-helper-bg-specificity">
				{% if not typeset.typesetter_invited %}
				<!-- url 'typeset' typeset.book.id typeset.id removed -->
				<p><a href="#">Typesetting for {{ typeset.book.title }} due on {{ typeset.due }}</a></p>
				{% else %}
				<p><a href="{% url 'typeset_typesetter' typeset.book.id typeset.id %}">Final Typesetting for {{ typeset.book.title }}</a></p>
				{% endif %}
			</div>
			{% empty %}
			<div class="bs-callout" id="callout-helper-bg-specificity">
				<p>No typesetting requests.</p>
			</div>
			{% endfor %}
		</div>
		{% endif %}
	</div>
</div>


<!-- Modal -->
<form id="task_form" class="form" method="POST" action="{% url 'task_new'%}">
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="myModalLabel">Creating New Task</h4>
      </div>
      <div class="modal-body">
      	{% csrf_token %}
    	{% bootstrap_form new_task_form %}
      </div>
      <div class="modal-footer">

        <button id="#new_task" class="btn btn-primary"><i class="fa fa-plus"></i> Add Task</button>
      </div>
    </div>
  </div>
</div>
</form>

{% endblock %}
{% block js %}
<script type="text/javascript">
  $(document).on("click", ":checkbox", function(){
        var id = $(this).attr('id');
        var div_id = "#task-" + $(this).attr('id');
        $.post("/user/task/" + id + "/complete/");
    	$( div_id ).remove()
    });
</script>

<script type="text/javascript">
    var frm = $('#task_form');
    frm.submit(function () {
        $.ajax({
            type: frm.attr('method'),
            url: frm.attr('action'),
            data: frm.serialize(),
            success: function (data) {
            	data = $.parseJSON(data);
                $( "#task-list" ).append( '<div id="task-' + data.id + '" class="bs-callout" id="callout-helper-bg-specificity"><label class="checkbox-inline"><input type="checkbox" id="'+ data.id + '" value="' + data.id + '"> ' + data.text + '</label></div>' );
                $('#id_text').val("");
                $('#myModal').modal('hide')
            },
            error: function(data) {
                $("#MESSAGE-DIV").html("Something went wrong!");
                console.log(data)
            }
        });
        return false;
    });
</script>
{% endblock %}
